name: Deploy Shopify Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ----------------------------------------
      ## 1. CHECKOUT
      # ----------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2. AUTHENTICATE WITH AWS USING OIDC
      # ----------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      # ----------------------------------------
      # 3. TERRAFORM INIT
      # ----------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

    #   - name: Terraform apply S3 only
    #     run: |
    #       terraform apply -target=module.s3 -auto-approve \
    #         -var "account_id=${{ secrets.ACCOUNT_ID }}" \
    #         -var "admin_username=${{ secrets.ADMIN_USERNAME }}" \
    #         -var "master_password=${{ secrets.MASTER_PASSWORD }}"



    #   # ----------------------------------------
    #   # 4. BUILD LAMBDA ZIP
    #   # ----------------------------------------
    #   - name: Build Lambda Package
    #     run: |
    #       cd lambda_code
    #       pip install -r requirements.txt -t .
    #       zip -r lambda.zip .

    # # ----------------------------------------
    #   # 5. UPLOAD ZIP TO ARTIFACT BUCKET
    #   # ----------------------------------------
    #   - name: Upload Lambda ZIP to S3
    #     run: |
    #       aws s3 cp lambda_code/lambda.zip "s3://${{ secrets.LAMBDA_BUCKET }}/lambda.zip"


    #   # ----------------------------------------
    #   # 6. FULL TERRAFORM APPLY â€” CREATE ALL INFRA
    #   # (INCLUDING THE LAMBDA ARTIFACT BUCKET)
    #   # ----------------------------------------
    #   - name: Terraform Plan 
    #     run: |
    #       terraform plan \
    #         -var "account_id=${{ secrets.ACCOUNT_ID }}" \
    #         -var "admin_username=${{ secrets.ADMIN_USERNAME }}" \
    #         -var "master_password=${{ secrets.MASTER_PASSWORD }}"

    #   - name: Terraform Apply 
    #     if: github.ref == 'refs/heads/main'
    #     run: |
    #       terraform apply -auto-approve \
    #         -var "account_id=${{ secrets.ACCOUNT_ID }}" \
    #         -var "admin_username=${{ secrets.ADMIN_USERNAME }}" \
    #         -var "master_password=${{ secrets.MASTER_PASSWORD }}"


    #   # ----------------------------------------
    #   # 7. APPLY AGAIN TO UPDATE LAMBDA CODE
    #   # ----------------------------------------
    #   - name: Terraform Apply (update lambda code)
    #     if: github.ref == 'refs/heads/main'
    #     run: |
    #       terraform apply -auto-approve \
    #         -var "account_id=${{ secrets.ACCOUNT_ID }}" \
    #         -var "admin_username=${{ secrets.ADMIN_USERNAME }}" \
    #         -var "master_password=${{ secrets.MASTER_PASSWORD }}" \
    #         -var "lambda_zip_key=lambda.zip"

      ## 8. Terraform destroy
      - name: Terraform Destroy
        run: |
          terraform destroy -auto-approve \
            -var "account_id=${{ secrets.ACCOUNT_ID }}" \
            -var "admin_username=${{ secrets.ADMIN_USERNAME }}" \
            -var "master_password=${{ secrets.MASTER_PASSWORD }}" \
            -var "lambda_zip_key=lambda.zip"
